#! /usr/bin/perl6

use Gamed;
use Gamed::Client;
use Gamed::Player;
use Gamed::Socket;

my $gamed = Gamed;
my $sock = Gamed::Socket.new(
		:localhost('localhost'),
		:localport(3939),
		:listen,
	);

say "Listening...";
my @players;
loop {
	if $sock.ready() {
		say "Got connection...";
		my $s = $sock.accept;
		my $c = Gamed::Client.new($s);
		@players.push({p=>Gamed::Player.new(:client($c)), s=>$s});
	}
	for @players -> $p {
		try {
			#if $p<s>.failed {
			#	say "delete";
			#	@players.delete($p.key);
			#}
			if $p<s>.ready {
				say "ready";
				$gamed.handle_message($p<p>, $p<p>.recv);
			}
			CATCH {
				say $!;
				exit;
			}
		}
	}
	sleep .1;
}

=begin END
my ( $help, $daemonize, $file, $man, $port );
GetOptions(
    'f|config'   => \$file,
    'h|help'   => \$help,
    'p|port=i' => \$port,
    'X'        => \$nodaemonize
) || pod2usage(2);
pod2usage(1) if ($help);

Gamed::main_loop();

__END__

=head1 NAME

gamed - run Gamed server

=head1 SYNOPSIS

gamed [-X] [-p port] [-f /path/to/config]

 Options:
   -f --file       File to use for config
   -h --help       Show this help
   -p --port       Bind to port instead of the default
   -X              Don't daemonize, stay in foreground
