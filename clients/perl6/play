#! /usr/bin/perl6

use JSON::Tiny;
use NativeCall;

#sub inputAvailable() returns Int is native('input') { ... }

my $conn = IO::Socket::INET.new(:host('localhost'), :port(3939))
		but role { 
			method give($hash){ self.send(to-json($hash)) }
			method take()     { from-json($!PIO.recv()) }
			method read()     { $!PIO.recv() }

			method ready () { 
					fail("Not connected") unless $!PIO; 
					return $!PIO.poll(1, 0, 0); 
			}

		};
		
$conn.give({s=>'login',name=>'Bruce'});
my $r = $conn.read();
$conn.give({s=>'join',game=>'HiLo'});
$r = $conn.read();

# This is for HiLo only for the moment
loop {
	print ">> ";
	my $cmd = $*IN.get;
	$conn.give({ g=>'guess', guess=>$cmd});
	say $conn.read;
}
